* Création carte microSD avec Win32DiskImager et image raspbian-jessie Lite

* login pi / pwd raspberry (par defaut)
sudo raspi-config
    Clavier français
    mot de passe: *****
    enable SSH
    timezone Paris
   
* Activation wifi DHCP
sudo nano /etc/network/interfaces
<<
auto lo
iface lo inet loopback

iface eth0 inet manual

allow-hotplug wlan0
auto wlan0
iface wlan0 inet dhcp
wpa-ssid *****
wpa-psk *****
>>
sudo reboot (sudo ifdown wlan0 / sudo ifup wlan0 ne marche pas la toute première fois)

* Mise à jour
sudo apt-get update
sudo apt-get upgrade

* Se connecter à l'interface d'admin de la Livebox, pour donner le nom raspberry à l'équipement raspberry dans la partie DNS

* Il est possible de se connecter par SSH avec login/pwd
* Pour pouvoir se connecter en SSH par clef, il faut copier la clef publique du client sur le raspberry
* Auparavant sur le client il faut générer un couple clef privée/publique (avec Putty)
* La clef privée reste sur le PC client
* La clef publique doit être ajoutée dans le fichier authorized_keys du raspberry
cd ~
mkdir -p .ssh
chmod 700 .ssh
nano .ssh/authorized_keys
y coller la clef publique précédée du texte ssh-rsa: <<ssh-rsa AAAAB...pQ==>>

* SAMBA (partage répertoire Windows)
sudo apt-get install samba samba-common-bin

sudo nano /etc/samba/smb.conf
<<
[global]
workgroup = WORKGROUP
server string = Raspberry Pi 0
netbios name = TeleInfo
dns proxy = no
acl allow execute always = True

[partage]
comment = Partage TeleInfo
path = /home/pi/partage
browseable = yes
writeable = yes
printable = no
valid users = pi
>>

mkdir ~/partage
sudo smbpasswd -a pi
   password ****

sudo /etc/init.d/samba restart

* GIT teleinfo
sudo apt-get install git
cd ~/partage
git clone https://github.com/SebGeek/teleinfo.git

* Pour éviter les problèmes de corruption de la carte SD
** suppression du swap sur la carte SD
sudo apt-get remove dphys-swapfile
sudo apt-get autoremove
sudo rm -f /var/swap
 
** Utilisation de tmpfs
sudo nano /etc/fstab
<<
tmpfs    /tmp    tmpfs    defaults,noatime,nosuid,size=10m    0 0
tmpfs    /var/tmp    tmpfs    defaults,noatime,nosuid,size=10m    0 0
tmpfs    /var/log    tmpfs    defaults,noatime,nosuid,mode=0755,size=10m    0 0
>>

* Activer liaison série /dev/ttyAMA0
- sudo raspi-config
    disable serial login
- sudo nano /boot/cmdline.txt
    dwc_otg.lpm_enable=0 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait
- sudo nano /boot/config.txt
    enable_uart=1
- si besoin: sudo systemctl mask serial-getty@ttyAMA0.service
- sudo nano /etc/rc.local
    Dans le fichier, juste avant exit 0, il faut ajouter la ligne suivante:
        stty -F /dev/ttyAMA0 1200 sane evenp parenb cs7 -crtscts
        1200 bauds, data 7 bits, 1 even bit, 1 stop bit
        
* install screen
sudo apt-get install screen

* install pip
sudo apt-get install python-pip

* install serial
sudo python -m pip install pyserial

* install Bluetooth Low Energy stack
sudo apt-get install bluetooth bluez

* MANUAL start-up of teleinfo looger
screen
cd partage/teleinfo/logger/
sudo python Teleinfo_Logger.py -o ../log/log.csv &
ctrl + A puis D
To reattach: screen -r

* AUTOMATIC start-up of teleinfo looger (after raspberry start-up)
sudo nano /etc/rc.local
Add line:
python /home/pi/partage/teleinfo/logger/Teleinfo_Logger.py -o /home/pi/partage/teleinfo/log/log.csv &
(no need sudo before python because rc.local is executed as root)
